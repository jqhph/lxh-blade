/**
 * version 1.0-dev
 *
 * Created by Jqh on 2017/7/3.
 */
window.BladeConfig={version:"1.0-dev",customTags:{},addTag:function(b,a){if("function"!=typeof a){throw Error("Invalid argument")}this.customTags[b]=a}};window.Blade=function(n,p){function t(a){return a.replace(new RegExp("["+c.delimiter.start+"|"+c.delimiter.end+"]","gi"),"")}function u(a,b,d){b=q(b.exp,null,!0,"");return c.model["$"+a].replace("{exp}",b).replace("{content}",'var key = "'+d+'"')}function x(a,b){return -1!=b.indexOf(c.placeholders["$"+a])&&-1!=b.indexOf(c.placeholders["$end"+a])?!0:!1}function r(a,b,d,e,f){var h=c.placeholders["$"+a],k=c.placeholders["$"+b];b=d.match(new RegExp(h+"[ ]*([^@]*?)\n","i"));if(!b||!b[0]){throw Error('Syntax error: "'+h+'" miss expression content')}d=d.replace(b[0],"");f&&"@"!=k&&(f=d.lastIndexOf(k),d=-1!=f?d.substr(0,f):d.replace(k,""));b=b[0].replace(new RegExp("(?:"+h+"[ ])*|\n","gi"),"");x(a,d)&&"if"==a&&(d=v(d));e?a=d:(a=d.match(new RegExp("([^"+k+"]*)","gi")),a=a[0]);d=d.replace(a,"");return{exp:b,content:a,full:d}}function l(a,b){return(a=b.match(c.regs[c.placeholders["$"+a]]))?a.length:0}var c={selector:"#blade",call:null,tpl:n,vars:{},delimiter:{start:"{",end:"}"},placeholders:{$if:"@if",$else:"@else",$elseif:"@elseif",$endif:"@endif",$foreach:"@foreach",$endforeach:"@endforeach",$end:"@",$tags:{compare:"@compare"},$customTags:{}},regs:{$var:/{([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+([\[]?([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+)[\]]?))}/gi,stringVar:/[\[]([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+)[\]]/gi,jsvar:/[ ]*((?![\'|\"])[\[_\.\]a-z]+[0-9\]]*)+[ ]*/gi,$if:/@if[ ]+([\s\S.])+@endif\b/gi,$foreach:/@foreach[ ]+([\s\S.])+@endforeach\b/gi,tag:/{(@[^{|{#]+)}/gi,tagName:/@[a-z]*\b/i,customTag:/{(@[^{|{#]+)@}/gi,"@if":/@if\b/gi,"@endif":/@endif\b/gi,"@elseif":/@elseif\b/gi,"@else":/@else\b/gi,"@foreach":/@foreach\b/gi,"@endforeach":/@endforeach\b/gi},model:{$if:"\n if ({exp}) { \n {content} \n } \n",$elseif:" else if ({exp}) { \n {content} \n } \n",$else:" else { \n {content} \n } \n"}};c.tpl=n;c.vars=p||{};c.placeholders.$customTags=BladeConfig.customTags;var w=this;this.getVars=function(){return c.vars};this.getTpl=function(){return c.tpl};this.fetch=function(a){c.vars=a||c.vars;a=c.tpl;var b=l("if",a),d=l("endif",a);if(b>d){throw Error('Syntax error: miss "'+c.placeholders.$endif+'"')}if(b<d){throw Error('Syntax error: miss "'+c.placeholders.$if+'"')}if(l("else",a)>b){throw Error('Syntax error: redundant "'+c.placeholders.$else+'" placeholder')}d=l("elseif",a);if(0==b&&0<d){throw Error('Syntax error: redundant "'+c.placeholders.$elseif+'" placeholder')}b=l("foreach",a);a=l("endforeach",a);if(b>a){throw Error('Syntax error: miss "'+c.placeholders.$endforeach+'"')}if(b<a){throw Error('Syntax error: miss "'+c.placeholders.$foreach+'"')}return q(y(z(v(A(c.tpl)))))};this.render=function(a,b){c.selector=a||c.selector;c.call=b||c.call;document.querySelector(c.selector).innerHTML=this.fetch();"function"!=typeof c.call||c.call(this)};this.rerender=function(a){c.vars=a||c.vars;this.render()};this.assign=function(a,b){"object"==typeof a?c.vars=a:c.vars[a]=b};var y=function(a){return a.replace(c.regs.customTag,function(b,d,a){a=d.match(c.regs.tagName);var e,h,k;d=d.replace(a[0],"");a=a[0].replace(c.placeholders.$end,"");for(e in c.placeholders.$customTags){if(e==a){b=B.transVar(d,!1,"!!").replace(/(^\s*)|(\s*$)/g,"");b=b.split("!!");a=[];for(h in b){if(0===b[h].indexOf("{")&&-1!=b[h].indexOf("}")){b[h]=JSON.parse(b[h]),a.push(b[h])}else{for(k in b[h]=b[h].replace(/'|"/g,""),d=b[h].split(" "),d){d[k]&&a.push(d[k])}}}return c.placeholders.$customTags[e](w,a,b)}}return b})},z=function(a){return a.replace(c.regs.tag,function(a,d,e){e=d.match(c.regs.tagName);e=e[0];for(var b in c.placeholders.$tags){if(e==c.placeholders.$tags[b]){return B[b](d.replace(e,""))}}return a})},B={compare:function(a){a=this.compareSyntaxAnalysis(a,"??",2);var b=this.compareSyntaxAnalysis(a[1],"::",1),d="{",c;for(c in b){"function"!=typeof b[c]&&(1==c&&(d+="} else {"),d=-1!=b[c].indexOf("'")||-1!=b[c].indexOf('"')?d+(" var result = "+b[c]):d+(" var result = "+this.transVar(b[c],!0)))}d="if ("+this.transVar(a[0],!0)+") "+d+"}";eval(d);return result||""},transVar:function(a,b,d){d=d||" ";return a.replace(c.regs.jsvar,function(a,c){a=C(c,null,b);return"object"==typeof a?d+JSON.stringify(a)+d:d+a+d})},compareSyntaxAnalysis:function(a,b,d){a=a.split(b);if(a.length<d){throw Error('Syntax error: "'+c.placeholders.$tags.compare+'" expression is not legal')}return a}},A=function(a){return a.replace(c.regs.$foreach,function(a,d,c){a=r("foreach","endforeach",a,!0,!0);c=a.exp.split(" ");var b=[];for(d=0;d<c.length;d++){c[d]&&"\n"!=c[d]&&b.push(c[d].replace(/[\s\n]/gi,""))}c="";var e,k=null,g,l=!1;e=b.shift();e=t(e);e=m(e)||[];1<b.length&&(k=b.shift());b=b.pop();for(d in e){if("function"!=typeof e[d]){g=a.content;k&&w.assign(t(k),d);w.assign(t(b),e[d]);if(l||x("foreach",g)){l=!0,g=A(g)}c+=q(y(z(v(g))))}}return c})},v=function(a,b){return a.replace(c.regs.$if,function(a,b,f){f=r("if","end",a);a=f.full;b=[];b.push(f.content);f=u("if",f,0);for(var d=l("elseif",a),e=1;e<=d;e++){var g=r("elseif","end",a);a=g.full;b.push(g.content);f+=u("elseif",g,e)}l("else",a)&&(g=r("else","end",a),g.full&&(a=g.full.replace("else","")),b.push(g.content),f+=u("else",g,e));eval(f);a&&(a=a.replace(c.placeholders.$endif,""));return(q(b[key])||"")+a})},q=function(a,b,d,e){return a?a.replace(c.regs.$var,function(a,c,k){return C(c,b,d,e)}):null},C=function(a,b,d,e){return -1==a.indexOf("[")?d?'"'+m(a,b,e)+'"':m(a,b,e):m(a.replace(c.regs.stringVar,function(a,c){return"."+m(c,b,e)}),e)},m=function(a,b,d){b=b||c.vars;for(var e=a.split("."),f=0;f<e.length;f++){if("undefined"!=typeof b[e[f]]){b=b[e[f]]}else{return"undefined"!=typeof d?d:a}}return b}};

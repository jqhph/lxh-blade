/**
 * version 1.0-dev
 *
 * Created by Jqh on 2017/7/3.
 */
window.BladeConfig={version:"1.0-dev",customTags:{},addTag:function(k,m){if("function"!=typeof m)throw Error("Invalid argument");this.customTags[k]=m}};window.Blade=function(k,m){function r(a){return a.replace(new RegExp("["+b.delimiter.start+"|"+b.delimiter.end+"]","gi"),"")}function t(a,c,d){c=n(c.exp,null,!0,"");return b.model["$"+a].replace("{exp}",c).replace("{content}",'var key = "'+d+'"')}function x(a,c){return-1!=c.indexOf(b.placeholders["$"+a])&&-1!=c.indexOf(b.placeholders["$end"+a])?!0:!1}function p(a,c,d,e,f){var u=b.placeholders["$"+a],q=b.placeholders["$"+c];c=d.match(new RegExp(u+"[ ]*([^@]*?)\n","i"));if(!c||!c[0])throw Error('Syntax error: "'+u+'" miss expression content');d=d.replace(c[0],"");f&&"@"!=q&&(f=d.lastIndexOf(q),d=-1!=f?d.substr(0,f):d.replace(q,""));c=c[0].replace(new RegExp("(?:"+u+"[ ])*|\n","gi"),"");x(a,d)&&"if"==a&&(d=v(d,"test"));e?a=d:(a=d.match(new RegExp("([^"+q+"]*)","gi")),a=a[0]);d=d.replace(a,"");return{exp:c,content:a,full:d}}function g(a,c){return(a=c.match(b.regs[b.placeholders["$"+a]]))?a.length:0}var b={selector:"#blade",call:null,tpl:k,vars:{},delimiter:{start:"{",end:"}"},placeholders:{$if:"@if",$else:"@else",$elseif:"@elseif",$endif:"@endif",$foreach:"@foreach",$endforeach:"@endforeach",$end:"@",$tags:{compare:"@compare"},$customTags:{}},regs:{$var:/{([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+([\[]?([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+)[\]]?))}/gi,stringVar:/[\[]([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+)[\]]/gi,jsvar:/[ ]+((?![\'|\"])[\[_\.\]a-z]+[0-9\]]*)+[ ]*/gi,$if:/@if[ ]+([\s\S.])+@endif\b/gi,$foreach:/@foreach[ ]+([\s\S.])+@endforeach\b/gi,tag:/{(@[^{|{#]+)}/gi,tagName:/@[a-z]*\b/i,customTag:/{(@[^{|{#]+)@}/gi,"@if":/@if\b/gi,"@endif":/@endif\b/gi,"@elseif":/@elseif\b/gi,"@else":/@else\b/gi,"@foreach":/@foreach\b/gi,"@endforeach":/@endforeach\b/gi},model:{$if:"\n if ({exp}) { \n {content} \n } \n",$elseif:" else if ({exp}) { \n {content} \n } \n",$else:" else { \n {content} \n } \n"}};b.tpl=k;b.vars=m||{};b.placeholders.$customTags=BladeConfig.customTags;var w=this;this.getVars=function(){return b.vars};this.getTpl=function(){return b.tpl};this.fetch=function(a){b.vars=a||b.vars;a=b.tpl;var c=g("if",a),d=g("endif",a);if(c>d)throw Error('Syntax error: miss "'+b.placeholders.$endif+'"');if(c<d)throw Error('Syntax error: miss "'+b.placeholders.$if+'"');if(g("else",a)>c)throw Error('Syntax error: redundant "'+b.placeholders.$else+'" placeholder');d=g("elseif",a);if(0==c&&0<d)throw Error('Syntax error: redundant "'+b.placeholders.$elseif+'" placeholder');c=g("foreach",a);a=g("endforeach",a);if(c>a)throw Error('Syntax error: miss "'+b.placeholders.$endforeach+'"');if(c<a)throw Error('Syntax error: miss "'+b.placeholders.$foreach+'"');return n(y(z(v(A(b.tpl)))))};this.render=function(a,c){b.selector=a||b.selector;b.call=c||b.call;document.querySelector(b.selector).innerHTML=this.fetch();"function"!=typeof b.call||b.call(this)};this.rerender=function(a){b.vars=a||b.vars;this.render()};this.assign=function(a,c){"object"==typeof a?b.vars=a:b.vars[a]=c};var y=function(a){return a.replace(b.regs.customTag,function(a,d,e){e=d.match(b.regs.tagName);var c;d=d.replace(e[0],"");e=e[0].replace(b.placeholders.$end,"");for(c in b.placeholders.$customTags)if(c==e)return a=B.transVar(d,!1).replace(/'|"/g,"").replace(/(^\s*)|(\s*$)/g,""),b.placeholders.$customTags[c](w,a.split(" "),a);return a})},z=function(a){return a.replace(b.regs.tag,function(a,d,e){e=d.match(b.regs.tagName);e=e[0];for(var c in b.placeholders.$tags)if(e==b.placeholders.$tags[c])return B[c](d.replace(e,""));return a})},B={compare:function(a){a=this.compareSyntaxAnalysis(a,"??",2);var c=this.compareSyntaxAnalysis(a[1],"::",1),d="{",b;for(b in c)"function"!=typeof c[b]&&(1==b&&(d+="} else {"),d=-1!=c[b].indexOf("'")||-1!=c[b].indexOf('"')?d+(" var result = "+c[b]):d+(" var result = "+this.transVar(c[b],!0)));d="if ("+this.transVar(a[0],!0)+") "+d+"}";eval(d);return result||""},transVar:function(a,c){return a.replace(b.regs.jsvar,function(a,b){return C(b,null,c)+" "})},compareSyntaxAnalysis:function(a,c,d){a=a.split(c);if(a.length<d)throw Error('Syntax error: "'+b.placeholders.$tags.compare+'" expression is not legal');return a}},A=function(a,c){return a.replace(b.regs.$foreach,function(a,b,c){a=p("foreach","endforeach",a,!0,!0);c=a.exp.split(" ");var d=[];for(b=0;b<c.length;b++)c[b]&&"\n"!=c[b]&&d.push(c[b].replace(/[\s\n]/gi,""));c="";var e,f=null,g,k=!1;e=d.shift();e=r(e);e=l(e)||[];1<d.length&&(f=d.shift());d=d.pop();for(b in e)if("function"!=typeof e[b]){g=a.content;f&&w.assign(r(f),b);w.assign(r(d),e[b]);if(k||x("foreach",g))k=!0,g=A(g,"test");c+=n(y(z(v(g))))}return c})},v=function(a,c){return a.replace(b.regs.$if,function(a,c,f){f=p("if","end",a);a=f.full;c=[];c.push(f.content);f=t("if",f,0);for(var d=g("elseif",a),e=1;e<=d;e++){var h=p("elseif","end",a);a=h.full;c.push(h.content);f+=t("elseif",h,e)}g("else",a)&&(h=p("else","end",a),h.full&&(a=h.full.replace("else","")),c.push(h.content),f+=t("else",h,e));eval(f);a&&(a=a.replace(b.placeholders.$endif,""));return(n(c[key])||"")+a})},n=function(a,c,d,e){return a?a.replace(b.regs.$var,function(a,b,g){return C(b,c,d,e)}):null},C=function(a,c,d,e){return-1==a.indexOf("[")?d?'"'+l(a,c,e)+'"':l(a,c,e):l(a.replace(b.regs.stringVar,function(a,b){return"."+l(b,c,e)}),e)},l=function(a,c,d){c=c||b.vars;for(var e=a.split("."),f=0;f<e.length;f++)if("undefined"!=typeof c[e[f]])c=c[e[f]];else return"undefined"!=typeof d?d:a;return c}};